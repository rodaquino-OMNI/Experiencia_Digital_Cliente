<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                  xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  id="Definitions_SUB006"
                  targetNamespace="http://bpmn.io/schema/bpmn">

  <bpmn:message id="Msg_SolicitacaoAutorizacao" name="Msg_SolicitacaoAutorizacao"/>
  <bpmn:signal id="Signal_AutorizacaoComplexa" name="Signal_AutorizacaoComplexa"/>
  <bpmn:error id="Error_AutorizacaoNegada" errorCode="ERR_AUTORIZACAO_NEGADA" name="Autorização Negada"/>

  <bpmn:process id="SUB-006_Autorizacao_Inteligente" name="SUB-006: Autorização Inteligente de Procedimentos"
                isExecutable="true" camunda:historyTimeToLive="730" camunda:versionTag="2.0">

    <bpmn:startEvent id="StartEvent_SolicitacaoAutorizacao" name="Solicitação de Autorização">
      <bpmn:outgoing>Flow_01</bpmn:outgoing>
      <bpmn:messageEventDefinition messageRef="Msg_SolicitacaoAutorizacao"/>
    </bpmn:startEvent>

    <bpmn:serviceTask id="Task_ValidarGuiaTISS" name="Validar Guia TISS"
                      camunda:delegateExpression="${tiss Service.validarGuia}">
      <bpmn:extensionElements>
        <camunda:failedJobRetryTimeCycle>R3/PT1M</camunda:failedJobRetryTimeCycle>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_01</bpmn:incoming>
      <bpmn:outgoing>Flow_02</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:serviceTask id="Task_VerificarCobertura" name="Verificar Cobertura Contratual"
                      camunda:delegateExpression="${coberturaService.verificar}">
      <bpmn:incoming>Flow_02</bpmn:incoming>
      <bpmn:outgoing>Flow_03</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:businessRuleTask id="Task_RegrasAutorizacao" name="Aplicar Regras de Autorização"
                           camunda:resultVariable="decisaoAutorizacao"
                           camunda:decisionRef="DMN_RegrasAutorizacao">
      <bpmn:incoming>Flow_03</bpmn:incoming>
      <bpmn:outgoing>Flow_04</bpmn:outgoing>
    </bpmn:businessRuleTask>

    <bpmn:businessRuleTask id="Task_ProtocoloClinico" name="Verificar Protocolo Clínico"
                           camunda:resultVariable="atendeProtocolo"
                           camunda:decisionRef="DMN_ProtocoloClinico">
      <bpmn:incoming>Flow_04</bpmn:incoming>
      <bpmn:outgoing>Flow_05</bpmn:outgoing>
    </bpmn:businessRuleTask>

    <bpmn:exclusiveGateway id="Gateway_RequerAuditoria" name="Requer Auditoria Médica?">
      <bpmn:incoming>Flow_05</bpmn:incoming>
      <bpmn:outgoing>Flow_06_Sim</bpmn:outgoing>
      <bpmn:outgoing>Flow_07_Nao</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:userTask id="UserTask_AuditoriaMedica" name="Análise de Auditoria Médica"
                   camunda:candidateGroups="auditores_medicos"
                   camunda:formKey="form_auditoria_medica">
      <bpmn:extensionElements>
        <camunda:taskListener event="create">
          <camunda:field name="sla">
            <camunda:string>PT24H</camunda:string>
          </camunda:field>
        </camunda:taskListener>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_06_Sim</bpmn:incoming>
      <bpmn:outgoing>Flow_08</bpmn:outgoing>
    </bpmn:userTask>

    <bpmn:exclusiveGateway id="Gateway_DecisaoFinal" name="Decisão Final?">
      <bpmn:incoming>Flow_07_Nao</bpmn:incoming>
      <bpmn:incoming>Flow_08</bpmn:incoming>
      <bpmn:outgoing>Flow_09_Aprovada</bpmn:outgoing>
      <bpmn:outgoing>Flow_10_Negada</bpmn:outgoing>
      <bpmn:outgoing>Flow_11_Parcial</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:serviceTask id="Task_GerarAutorizacao" name="Gerar Número de Autorização"
                      camunda:delegateExpression="${autorizacaoService.gerar}">
      <bpmn:incoming>Flow_09_Aprovada</bpmn:incoming>
      <bpmn:outgoing>Flow_12</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:serviceTask id="Task_RegistrarNegativa" name="Registrar Negativa com Justificativa"
                      camunda:delegateExpression="${autorizacaoService.registrarNegativa}">
      <bpmn:incoming>Flow_10_Negada</bpmn:incoming>
      <bpmn:outgoing>Flow_13</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:serviceTask id="Task_GerarAutorizacaoParcial" name="Gerar Autorização Parcial"
                      camunda:delegateExpression="${autorizacaoService.gerarParcial}">
      <bpmn:incoming>Flow_11_Parcial</bpmn:incoming>
      <bpmn:outgoing>Flow_14</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:serviceTask id="Task_NotificarBeneficiario" name="Notificar Beneficiário"
                      camunda:type="external"
                      camunda:topic="whatsapp-sender">
      <bpmn:incoming>Flow_12</bpmn:incoming>
      <bpmn:incoming>Flow_14</bpmn:incoming>
      <bpmn:outgoing>Flow_15</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:serviceTask id="Task_NotificarNegativa" name="Notificar Negativa e Direitos"
                      camunda:type="external"
                      camunda:topic="whatsapp-sender">
      <bpmn:incoming>Flow_13</bpmn:incoming>
      <bpmn:outgoing>Flow_16</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:serviceTask id="Task_PublicarEvento" name="Publicar Evento: Autorização Processada"
                      camunda:delegateExpression="${kafkaPublisherService.publicar}">
      <bpmn:incoming>Flow_15</bpmn:incoming>
      <bpmn:incoming>Flow_16</bpmn:incoming>
      <bpmn:outgoing>Flow_17</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:endEvent id="EndEvent_AutorizacaoProcessada" name="Autorização Processada">
      <bpmn:incoming>Flow_17</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:sequenceFlow id="Flow_01" sourceRef="StartEvent_SolicitacaoAutorizacao" targetRef="Task_ValidarGuiaTISS"/>
    <bpmn:sequenceFlow id="Flow_02" sourceRef="Task_ValidarGuiaTISS" targetRef="Task_VerificarCobertura"/>
    <bpmn:sequenceFlow id="Flow_03" sourceRef="Task_VerificarCobertura" targetRef="Task_RegrasAutorizacao"/>
    <bpmn:sequenceFlow id="Flow_04" sourceRef="Task_RegrasAutorizacao" targetRef="Task_ProtocoloClinico"/>
    <bpmn:sequenceFlow id="Flow_05" sourceRef="Task_ProtocoloClinico" targetRef="Gateway_RequerAuditoria"/>
    <bpmn:sequenceFlow id="Flow_06_Sim" name="SIM" sourceRef="Gateway_RequerAuditoria" targetRef="UserTask_AuditoriaMedica">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${requerAuditoria == true}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_07_Nao" name="NÃO" sourceRef="Gateway_RequerAuditoria" targetRef="Gateway_DecisaoFinal">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${requerAuditoria == false}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_08" sourceRef="UserTask_AuditoriaMedica" targetRef="Gateway_DecisaoFinal"/>
    <bpmn:sequenceFlow id="Flow_09_Aprovada" name="Aprovada" sourceRef="Gateway_DecisaoFinal" targetRef="Task_GerarAutorizacao">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${statusAutorizacao == 'APROVADA'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_10_Negada" name="Negada" sourceRef="Gateway_DecisaoFinal" targetRef="Task_RegistrarNegativa">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${statusAutorizacao == 'NEGADA'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_11_Parcial" name="Parcial" sourceRef="Gateway_DecisaoFinal" targetRef="Task_GerarAutorizacaoParcial">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${statusAutorizacao == 'PARCIAL'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_12" sourceRef="Task_GerarAutorizacao" targetRef="Task_NotificarBeneficiario"/>
    <bpmn:sequenceFlow id="Flow_13" sourceRef="Task_RegistrarNegativa" targetRef="Task_NotificarNegativa"/>
    <bpmn:sequenceFlow id="Flow_14" sourceRef="Task_GerarAutorizacaoParcial" targetRef="Task_NotificarBeneficiario"/>
    <bpmn:sequenceFlow id="Flow_15" sourceRef="Task_NotificarBeneficiario" targetRef="Task_PublicarEvento"/>
    <bpmn:sequenceFlow id="Flow_16" sourceRef="Task_NotificarNegativa" targetRef="Task_PublicarEvento"/>
    <bpmn:sequenceFlow id="Flow_17" sourceRef="Task_PublicarEvento" targetRef="EndEvent_AutorizacaoProcessada"/>

  </bpmn:process>

  <bpmndi:BPMNDiagram id="BPMNDiagram_SUB006">
    <bpmndi:BPMNPlane id="BPMNPlane_SUB006" bpmnElement="SUB-006_Autorizacao_Inteligente">

      <!-- Start Event Shape -->
      <bpmndi:BPMNShape id="StartEvent_SolicitacaoAutorizacao_di" bpmnElement="StartEvent_SolicitacaoAutorizacao">
        <dc:Bounds x="172" y="102" width="36" height="36"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds x="154" y="145" width="72" height="27"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Service Task: Validar Guia TISS -->
      <bpmndi:BPMNShape id="Task_ValidarGuiaTISS_di" bpmnElement="Task_ValidarGuiaTISS">
        <dc:Bounds x="270" y="80" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <!-- Service Task: Verificar Cobertura -->
      <bpmndi:BPMNShape id="Task_VerificarCobertura_di" bpmnElement="Task_VerificarCobertura">
        <dc:Bounds x="430" y="80" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <!-- Business Rule Task: Regras Autorização -->
      <bpmndi:BPMNShape id="Task_RegrasAutorizacao_di" bpmnElement="Task_RegrasAutorizacao">
        <dc:Bounds x="590" y="80" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <!-- Business Rule Task: Protocolo Clínico -->
      <bpmndi:BPMNShape id="Task_ProtocoloClinico_di" bpmnElement="Task_ProtocoloClinico">
        <dc:Bounds x="750" y="80" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <!-- Gateway: Requer Auditoria -->
      <bpmndi:BPMNShape id="Gateway_RequerAuditoria_di" bpmnElement="Gateway_RequerAuditoria">
        <dc:Bounds x="905" y="95" width="50" height="50"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds x="895" y="152" width="70" height="27"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- User Task: Auditoria Médica -->
      <bpmndi:BPMNShape id="UserTask_AuditoriaMedica_di" bpmnElement="UserTask_AuditoriaMedica">
        <dc:Bounds x="880" y="210" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <!-- Gateway: Decisão Final -->
      <bpmndi:BPMNShape id="Gateway_DecisaoFinal_di" bpmnElement="Gateway_DecisaoFinal">
        <dc:Bounds x="1045" y="95" width="50" height="50"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1027" y="152" width="86" height="14"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Service Task: Gerar Autorização -->
      <bpmndi:BPMNShape id="Task_GerarAutorizacao_di" bpmnElement="Task_GerarAutorizacao">
        <dc:Bounds x="1150" y="20" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <!-- Service Task: Registrar Negativa -->
      <bpmndi:BPMNShape id="Task_RegistrarNegativa_di" bpmnElement="Task_RegistrarNegativa">
        <dc:Bounds x="1150" y="120" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <!-- Service Task: Gerar Autorização Parcial -->
      <bpmndi:BPMNShape id="Task_GerarAutorizacaoParcial_di" bpmnElement="Task_GerarAutorizacaoParcial">
        <dc:Bounds x="1150" y="220" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <!-- Service Task: Notificar Beneficiário -->
      <bpmndi:BPMNShape id="Task_NotificarBeneficiario_di" bpmnElement="Task_NotificarBeneficiario">
        <dc:Bounds x="1310" y="80" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <!-- Service Task: Notificar Negativa -->
      <bpmndi:BPMNShape id="Task_NotificarNegativa_di" bpmnElement="Task_NotificarNegativa">
        <dc:Bounds x="1310" y="200" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <!-- Service Task: Publicar Evento -->
      <bpmndi:BPMNShape id="Task_PublicarEvento_di" bpmnElement="Task_PublicarEvento">
        <dc:Bounds x="1470" y="120" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <!-- End Event -->
      <bpmndi:BPMNShape id="EndEvent_AutorizacaoProcessada_di" bpmnElement="EndEvent_AutorizacaoProcessada">
        <dc:Bounds x="1632" y="142" width="36" height="36"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1616" y="185" width="68" height="27"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Sequence Flow Edges -->
      <bpmndi:BPMNEdge id="Flow_01_di" bpmnElement="Flow_01">
        <di:waypoint x="208" y="120"/>
        <di:waypoint x="270" y="120"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_02_di" bpmnElement="Flow_02">
        <di:waypoint x="370" y="120"/>
        <di:waypoint x="430" y="120"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_03_di" bpmnElement="Flow_03">
        <di:waypoint x="530" y="120"/>
        <di:waypoint x="590" y="120"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_04_di" bpmnElement="Flow_04">
        <di:waypoint x="690" y="120"/>
        <di:waypoint x="750" y="120"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_05_di" bpmnElement="Flow_05">
        <di:waypoint x="850" y="120"/>
        <di:waypoint x="905" y="120"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_06_Sim_di" bpmnElement="Flow_06_Sim">
        <di:waypoint x="930" y="145"/>
        <di:waypoint x="930" y="210"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_07_Nao_di" bpmnElement="Flow_07_Nao">
        <di:waypoint x="955" y="120"/>
        <di:waypoint x="1045" y="120"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_08_di" bpmnElement="Flow_08">
        <di:waypoint x="980" y="250"/>
        <di:waypoint x="1070" y="250"/>
        <di:waypoint x="1070" y="145"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_09_Aprovada_di" bpmnElement="Flow_09_Aprovada">
        <di:waypoint x="1070" y="95"/>
        <di:waypoint x="1070" y="60"/>
        <di:waypoint x="1150" y="60"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_10_Negada_di" bpmnElement="Flow_10_Negada">
        <di:waypoint x="1070" y="120"/>
        <di:waypoint x="1070" y="160"/>
        <di:waypoint x="1150" y="160"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_11_Parcial_di" bpmnElement="Flow_11_Parcial">
        <di:waypoint x="1070" y="145"/>
        <di:waypoint x="1070" y="260"/>
        <di:waypoint x="1150" y="260"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_12_di" bpmnElement="Flow_12">
        <di:waypoint x="1250" y="60"/>
        <di:waypoint x="1360" y="60"/>
        <di:waypoint x="1360" y="80"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_13_di" bpmnElement="Flow_13">
        <di:waypoint x="1250" y="160"/>
        <di:waypoint x="1360" y="160"/>
        <di:waypoint x="1360" y="200"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_14_di" bpmnElement="Flow_14">
        <di:waypoint x="1250" y="260"/>
        <di:waypoint x="1360" y="260"/>
        <di:waypoint x="1360" y="160"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_15_di" bpmnElement="Flow_15">
        <di:waypoint x="1410" y="120"/>
        <di:waypoint x="1520" y="120"/>
        <di:waypoint x="1520" y="120"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_16_di" bpmnElement="Flow_16">
        <di:waypoint x="1410" y="240"/>
        <di:waypoint x="1520" y="240"/>
        <di:waypoint x="1520" y="200"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_17_di" bpmnElement="Flow_17">
        <di:waypoint x="1570" y="160"/>
        <di:waypoint x="1632" y="160"/>
      </bpmndi:BPMNEdge>

    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>

</bpmn:definitions>
