<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                  xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  id="Definitions_SUB005"
                  targetNamespace="http://bpmn.io/schema/bpmn">

  <bpmn:signal id="Signal_RoteadoAgenteIA" name="Signal_RoteadoAgenteIA"/>
  <bpmn:signal id="Signal_EscalarNavegador" name="Signal_EscalarNavegador"/>
  <bpmn:message id="Msg_SolicitacaoAutorizacao" name="Msg_SolicitacaoAutorizacao"/>

  <bpmn:process id="SUB-005_Agentes_IA" name="SUB-005: Atendimento por Agentes IA"
                isExecutable="true" camunda:historyTimeToLive="180" camunda:versionTag="2.0">

    <bpmn:startEvent id="StartEvent_AgenteIA" name="Roteado Agente IA">
      <bpmn:outgoing>Flow_01</bpmn:outgoing>
      <bpmn:signalEventDefinition signalRef="Signal_RoteadoAgenteIA"/>
    </bpmn:startEvent>

    <bpmn:serviceTask id="Task_SelecionarAgenteIA" name="Selecionar Agente IA Especializado"
                      camunda:delegateExpression="${agenteIAService.selecionar}">
      <bpmn:incoming>Flow_01</bpmn:incoming>
      <bpmn:outgoing>Flow_02</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:serviceTask id="Task_ProcessarConversacao" name="Processar Conversação (GPT-4)"
                      camunda:type="external"
                      camunda:topic="gpt4-conversation">
      <bpmn:extensionElements>
        <camunda:failedJobRetryTimeCycle>R3/PT30S</camunda:failedJobRetryTimeCycle>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_02</bpmn:incoming>
      <bpmn:outgoing>Flow_03</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:exclusiveGateway id="Gateway_RequerAutorizacao" name="Requer Autorização?">
      <bpmn:incoming>Flow_03</bpmn:incoming>
      <bpmn:outgoing>Flow_04_Sim</bpmn:outgoing>
      <bpmn:outgoing>Flow_05_Nao</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:callActivity id="CallActivity_SUB006" name="SUB-006: Autorização"
                       calledElement="SUB-006_Autorizacao_Inteligente">
      <bpmn:extensionElements>
        <camunda:in source="beneficiarioId" target="beneficiarioId"/>
        <camunda:in source="autorizacaoRequest" target="autorizacaoRequest"/>
        <camunda:out source="autorizacaoId" target="autorizacaoId"/>
        <camunda:out source="statusAutorizacao" target="statusAutorizacao"/>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_04_Sim</bpmn:incoming>
      <bpmn:outgoing>Flow_06</bpmn:outgoing>
    </bpmn:callActivity>

    <bpmn:serviceTask id="Task_ExecutarAcao" name="Executar Ação Solicitada"
                      camunda:delegateExpression="${agenteIAService.executarAcao}">
      <bpmn:incoming>Flow_05_Nao</bpmn:incoming>
      <bpmn:incoming>Flow_06</bpmn:incoming>
      <bpmn:outgoing>Flow_07</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:exclusiveGateway id="Gateway_DemandaResolvida" name="Demanda Resolvida?">
      <bpmn:incoming>Flow_07</bpmn:incoming>
      <bpmn:outgoing>Flow_08_Sim</bpmn:outgoing>
      <bpmn:outgoing>Flow_09_Nao</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:intermediateThrowEvent id="Event_EscalarNavegador" name="Escalar para Navegador">
      <bpmn:incoming>Flow_09_Nao</bpmn:incoming>
      <bpmn:outgoing>Flow_10</bpmn:outgoing>
      <bpmn:signalEventDefinition signalRef="Signal_EscalarNavegador"/>
    </bpmn:intermediateThrowEvent>

    <bpmn:serviceTask id="Task_RegistrarAtendimento" name="Registrar Atendimento"
                      camunda:delegateExpression="${atendimentoService.registrar}">
      <bpmn:incoming>Flow_08_Sim</bpmn:incoming>
      <bpmn:outgoing>Flow_11</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:serviceTask id="Task_AvaliarQualidade" name="Avaliar Qualidade (ML)"
                      camunda:type="external"
                      camunda:topic="ml-quality-assessment">
      <bpmn:incoming>Flow_11</bpmn:incoming>
      <bpmn:outgoing>Flow_12</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:endEvent id="EndEvent_Resolvido" name="Atendimento Concluído">
      <bpmn:incoming>Flow_12</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:endEvent id="EndEvent_Escalado" name="Escalado">
      <bpmn:incoming>Flow_10</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:sequenceFlow id="Flow_01" sourceRef="StartEvent_AgenteIA" targetRef="Task_SelecionarAgenteIA"/>
    <bpmn:sequenceFlow id="Flow_02" sourceRef="Task_SelecionarAgenteIA" targetRef="Task_ProcessarConversacao"/>
    <bpmn:sequenceFlow id="Flow_03" sourceRef="Task_ProcessarConversacao" targetRef="Gateway_RequerAutorizacao"/>
    <bpmn:sequenceFlow id="Flow_04_Sim" name="SIM" sourceRef="Gateway_RequerAutorizacao" targetRef="CallActivity_SUB006">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${requerAutorizacao == true}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_05_Nao" name="NÃO" sourceRef="Gateway_RequerAutorizacao" targetRef="Task_ExecutarAcao">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${requerAutorizacao == false}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_06" sourceRef="CallActivity_SUB006" targetRef="Task_ExecutarAcao"/>
    <bpmn:sequenceFlow id="Flow_07" sourceRef="Task_ExecutarAcao" targetRef="Gateway_DemandaResolvida"/>
    <bpmn:sequenceFlow id="Flow_08_Sim" name="SIM" sourceRef="Gateway_DemandaResolvida" targetRef="Task_RegistrarAtendimento">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${demandaResolvida == true}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_09_Nao" name="NÃO" sourceRef="Gateway_DemandaResolvida" targetRef="Event_EscalarNavegador">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${demandaResolvida == false}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_10" sourceRef="Event_EscalarNavegador" targetRef="EndEvent_Escalado"/>
    <bpmn:sequenceFlow id="Flow_11" sourceRef="Task_RegistrarAtendimento" targetRef="Task_AvaliarQualidade"/>
    <bpmn:sequenceFlow id="Flow_12" sourceRef="Task_AvaliarQualidade" targetRef="EndEvent_Resolvido"/>

  </bpmn:process>

  <bpmndi:BPMNDiagram id="BPMNDiagram_SUB005">
    <bpmndi:BPMNPlane id="BPMNPlane_SUB005" bpmnElement="SUB-005_Agentes_IA">

      <!-- Start Event Shape -->
      <bpmndi:BPMNShape id="StartEvent_AgenteIA_di" bpmnElement="StartEvent_AgenteIA">
        <dc:Bounds x="172" y="102" width="36" height="36"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds x="153" y="145" width="74" height="27"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Service Task: Selecionar Agente IA -->
      <bpmndi:BPMNShape id="Task_SelecionarAgenteIA_di" bpmnElement="Task_SelecionarAgenteIA">
        <dc:Bounds x="270" y="80" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <!-- Service Task: Processar Conversação -->
      <bpmndi:BPMNShape id="Task_ProcessarConversacao_di" bpmnElement="Task_ProcessarConversacao">
        <dc:Bounds x="430" y="80" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <!-- Gateway: Requer Autorização -->
      <bpmndi:BPMNShape id="Gateway_RequerAutorizacao_di" bpmnElement="Gateway_RequerAutorizacao">
        <dc:Bounds x="585" y="95" width="50" height="50"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds x="572" y="152" width="76" height="27"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Call Activity: SUB-006 -->
      <bpmndi:BPMNShape id="CallActivity_SUB006_di" bpmnElement="CallActivity_SUB006">
        <dc:Bounds x="690" y="20" width="130" height="80"/>
      </bpmndi:BPMNShape>

      <!-- Service Task: Executar Ação -->
      <bpmndi:BPMNShape id="Task_ExecutarAcao_di" bpmnElement="Task_ExecutarAcao">
        <dc:Bounds x="870" y="80" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <!-- Gateway: Demanda Resolvida -->
      <bpmndi:BPMNShape id="Gateway_DemandaResolvida_di" bpmnElement="Gateway_DemandaResolvida">
        <dc:Bounds x="1025" y="95" width="50" height="50"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1009" y="152" width="82" height="27"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Intermediate Throw Event: Escalar -->
      <bpmndi:BPMNShape id="Event_EscalarNavegador_di" bpmnElement="Event_EscalarNavegador">
        <dc:Bounds x="1032" y="202" width="36" height="36"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1013" y="245" width="74" height="27"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Service Task: Registrar Atendimento -->
      <bpmndi:BPMNShape id="Task_RegistrarAtendimento_di" bpmnElement="Task_RegistrarAtendimento">
        <dc:Bounds x="1130" y="80" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <!-- Service Task: Avaliar Qualidade -->
      <bpmndi:BPMNShape id="Task_AvaliarQualidade_di" bpmnElement="Task_AvaliarQualidade">
        <dc:Bounds x="1290" y="80" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <!-- End Event: Resolvido -->
      <bpmndi:BPMNShape id="EndEvent_Resolvido_di" bpmnElement="EndEvent_Resolvido">
        <dc:Bounds x="1452" y="102" width="36" height="36"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1431" y="145" width="78" height="27"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- End Event: Escalado -->
      <bpmndi:BPMNShape id="EndEvent_Escalado_di" bpmnElement="EndEvent_Escalado">
        <dc:Bounds x="1132" y="202" width="36" height="36"/>
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1126" y="245" width="48" height="14"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Sequence Flow Edges -->
      <bpmndi:BPMNEdge id="Flow_01_di" bpmnElement="Flow_01">
        <di:waypoint x="208" y="120"/>
        <di:waypoint x="270" y="120"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_02_di" bpmnElement="Flow_02">
        <di:waypoint x="370" y="120"/>
        <di:waypoint x="430" y="120"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_03_di" bpmnElement="Flow_03">
        <di:waypoint x="530" y="120"/>
        <di:waypoint x="585" y="120"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_04_Sim_di" bpmnElement="Flow_04_Sim">
        <di:waypoint x="610" y="95"/>
        <di:waypoint x="610" y="60"/>
        <di:waypoint x="690" y="60"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_05_Nao_di" bpmnElement="Flow_05_Nao">
        <di:waypoint x="635" y="120"/>
        <di:waypoint x="870" y="120"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_06_di" bpmnElement="Flow_06">
        <di:waypoint x="820" y="60"/>
        <di:waypoint x="920" y="60"/>
        <di:waypoint x="920" y="80"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_07_di" bpmnElement="Flow_07">
        <di:waypoint x="970" y="120"/>
        <di:waypoint x="1025" y="120"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_08_Sim_di" bpmnElement="Flow_08_Sim">
        <di:waypoint x="1075" y="120"/>
        <di:waypoint x="1130" y="120"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_09_Nao_di" bpmnElement="Flow_09_Nao">
        <di:waypoint x="1050" y="145"/>
        <di:waypoint x="1050" y="202"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_10_di" bpmnElement="Flow_10">
        <di:waypoint x="1068" y="220"/>
        <di:waypoint x="1132" y="220"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_11_di" bpmnElement="Flow_11">
        <di:waypoint x="1230" y="120"/>
        <di:waypoint x="1290" y="120"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_12_di" bpmnElement="Flow_12">
        <di:waypoint x="1390" y="120"/>
        <di:waypoint x="1452" y="120"/>
      </bpmndi:BPMNEdge>

    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>

</bpmn:definitions>
