<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                  xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  id="Definitions_SUB004"
                  targetNamespace="http://bpmn.io/schema/bpmn">

  <bpmn:signal id="Signal_RoteadoSelfService" name="Signal_RoteadoSelfService"/>
  <bpmn:signal id="Signal_EscalarAgenteIA" name="Signal_EscalarAgenteIA"/>

  <bpmn:process id="SUB-004_Self_Service" name="SUB-004: Self-Service e Autoatendimento"
                isExecutable="true" camunda:historyTimeToLive="180" camunda:versionTag="2.0">

    <bpmn:startEvent id="StartEvent_SelfService" name="Roteado Self-Service">
      <bpmn:outgoing>Flow_01</bpmn:outgoing>
      <bpmn:signalEventDefinition signalRef="Signal_RoteadoSelfService"/>
    </bpmn:startEvent>

    <bpmn:businessRuleTask id="Task_IdentificarFluxo" name="Identificar Fluxo Self-Service"
                           camunda:resultVariable="fluxoSelfService"
                           camunda:decisionRef="DMN_FluxoSelfService">
      <bpmn:incoming>Flow_01</bpmn:incoming>
      <bpmn:outgoing>Flow_02</bpmn:outgoing>
    </bpmn:businessRuleTask>

    <bpmn:exclusiveGateway id="Gateway_TipoFluxo" name="Tipo de Fluxo?">
      <bpmn:incoming>Flow_02</bpmn:incoming>
      <bpmn:outgoing>Flow_03_ConsultarDados</bpmn:outgoing>
      <bpmn:outgoing>Flow_04_Agendamento</bpmn:outgoing>
      <bpmn:outgoing>Flow_05_2Via</bpmn:outgoing>
      <bpmn:outgoing>Flow_06_Duvidas</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:serviceTask id="Task_ConsultarDados" name="Consultar Dados"
                      camunda:delegateExpression="${selfServiceService.consultarDados}">
      <bpmn:incoming>Flow_03_ConsultarDados</bpmn:incoming>
      <bpmn:outgoing>Flow_07</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:callActivity id="CallActivity_Agendamento" name="Fluxo de Agendamento"
                       calledElement="SUB-004-001_Agendamento">
      <bpmn:extensionElements>
        <camunda:in source="beneficiarioId" target="beneficiarioId"/>
        <camunda:out source="agendamentoRealizado" target="agendamentoRealizado"/>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_04_Agendamento</bpmn:incoming>
      <bpmn:outgoing>Flow_08</bpmn:outgoing>
    </bpmn:callActivity>

    <bpmn:serviceTask id="Task_Gerar2Via" name="Gerar 2ª Via"
                      camunda:delegateExpression="${selfServiceService.gerar2Via}">
      <bpmn:incoming>Flow_05_2Via</bpmn:incoming>
      <bpmn:outgoing>Flow_09</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:serviceTask id="Task_ResponderDuvida" name="Responder Dúvida Frequente"
                      camunda:delegateExpression="${knowledgeBaseService.responder}">
      <bpmn:incoming>Flow_06_Duvidas</bpmn:incoming>
      <bpmn:outgoing>Flow_10</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:exclusiveGateway id="Gateway_Resolvido" name="Demanda Resolvida?">
      <bpmn:incoming>Flow_07</bpmn:incoming>
      <bpmn:incoming>Flow_08</bpmn:incoming>
      <bpmn:incoming>Flow_09</bpmn:incoming>
      <bpmn:incoming>Flow_10</bpmn:incoming>
      <bpmn:outgoing>Flow_11_Sim</bpmn:outgoing>
      <bpmn:outgoing>Flow_12_Nao</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:intermediateThrowEvent id="Event_EscalarAgenteIA" name="Escalar para Agente IA">
      <bpmn:incoming>Flow_12_Nao</bpmn:incoming>
      <bpmn:outgoing>Flow_13</bpmn:outgoing>
      <bpmn:signalEventDefinition signalRef="Signal_EscalarAgenteIA"/>
    </bpmn:intermediateThrowEvent>

    <bpmn:endEvent id="EndEvent_Resolvido" name="Demanda Resolvida">
      <bpmn:incoming>Flow_11_Sim</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:endEvent id="EndEvent_Escalado" name="Escalado">
      <bpmn:incoming>Flow_13</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:sequenceFlow id="Flow_01" sourceRef="StartEvent_SelfService" targetRef="Task_IdentificarFluxo"/>
    <bpmn:sequenceFlow id="Flow_02" sourceRef="Task_IdentificarFluxo" targetRef="Gateway_TipoFluxo"/>
    <bpmn:sequenceFlow id="Flow_03_ConsultarDados" name="Consultar Dados" sourceRef="Gateway_TipoFluxo" targetRef="Task_ConsultarDados">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${fluxoSelfService == 'CONSULTAR_DADOS'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_04_Agendamento" name="Agendamento" sourceRef="Gateway_TipoFluxo" targetRef="CallActivity_Agendamento">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${fluxoSelfService == 'AGENDAMENTO'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_05_2Via" name="2ª Via" sourceRef="Gateway_TipoFluxo" targetRef="Task_Gerar2Via">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${fluxoSelfService == 'SEGUNDA_VIA'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_06_Duvidas" name="Dúvidas" sourceRef="Gateway_TipoFluxo" targetRef="Task_ResponderDuvida">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${fluxoSelfService == 'DUVIDAS'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_07" sourceRef="Task_ConsultarDados" targetRef="Gateway_Resolvido"/>
    <bpmn:sequenceFlow id="Flow_08" sourceRef="CallActivity_Agendamento" targetRef="Gateway_Resolvido"/>
    <bpmn:sequenceFlow id="Flow_09" sourceRef="Task_Gerar2Via" targetRef="Gateway_Resolvido"/>
    <bpmn:sequenceFlow id="Flow_10" sourceRef="Task_ResponderDuvida" targetRef="Gateway_Resolvido"/>
    <bpmn:sequenceFlow id="Flow_11_Sim" name="SIM" sourceRef="Gateway_Resolvido" targetRef="EndEvent_Resolvido">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${demandaResolvida == true}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_12_Nao" name="NÃO" sourceRef="Gateway_Resolvido" targetRef="Event_EscalarAgenteIA">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${demandaResolvida == false}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_13" sourceRef="Event_EscalarAgenteIA" targetRef="EndEvent_Escalado"/>

  </bpmn:process>

  <bpmndi:BPMNDiagram id="BPMNDiagram_SUB004">
    <bpmndi:BPMNPlane id="BPMNPlane_SUB004" bpmnElement="SUB-004_Self_Service">

      <!-- Start Event -->
      <bpmndi:BPMNShape id="StartEvent_SelfService_di" bpmnElement="StartEvent_SelfService">
        <dc:Bounds x="172" y="222" width="36" height="36"/>
      </bpmndi:BPMNShape>

      <!-- Business Rule Task -->
      <bpmndi:BPMNShape id="Task_IdentificarFluxo_di" bpmnElement="Task_IdentificarFluxo">
        <dc:Bounds x="280" y="200" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <!-- First Gateway -->
      <bpmndi:BPMNShape id="Gateway_TipoFluxo_di" bpmnElement="Gateway_TipoFluxo">
        <dc:Bounds x="455" y="215" width="50" height="50"/>
      </bpmndi:BPMNShape>

      <!-- Service Tasks for Different Flows -->
      <bpmndi:BPMNShape id="Task_ConsultarDados_di" bpmnElement="Task_ConsultarDados">
        <dc:Bounds x="600" y="80" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="CallActivity_Agendamento_di" bpmnElement="CallActivity_Agendamento">
        <dc:Bounds x="600" y="195" width="130" height="90"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="Task_Gerar2Via_di" bpmnElement="Task_Gerar2Via">
        <dc:Bounds x="600" y="310" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="Task_ResponderDuvida_di" bpmnElement="Task_ResponderDuvida">
        <dc:Bounds x="600" y="420" width="100" height="80"/>
      </bpmndi:BPMNShape>

      <!-- Second Gateway (Resolution Check) -->
      <bpmndi:BPMNShape id="Gateway_Resolvido_di" bpmnElement="Gateway_Resolvido">
        <dc:Bounds x="805" y="215" width="50" height="50"/>
      </bpmndi:BPMNShape>

      <!-- Intermediate Throw Event -->
      <bpmndi:BPMNShape id="Event_EscalarAgenteIA_di" bpmnElement="Event_EscalarAgenteIA">
        <dc:Bounds x="942" y="302" width="36" height="36"/>
      </bpmndi:BPMNShape>

      <!-- End Events -->
      <bpmndi:BPMNShape id="EndEvent_Resolvido_di" bpmnElement="EndEvent_Resolvido">
        <dc:Bounds x="942" y="222" width="36" height="36"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="EndEvent_Escalado_di" bpmnElement="EndEvent_Escalado">
        <dc:Bounds x="1042" y="302" width="36" height="36"/>
      </bpmndi:BPMNShape>

      <!-- Sequence Flows (Edges) -->
      <bpmndi:BPMNEdge id="Flow_01_di" bpmnElement="Flow_01">
        <di:waypoint x="208" y="240"/>
        <di:waypoint x="280" y="240"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_02_di" bpmnElement="Flow_02">
        <di:waypoint x="380" y="240"/>
        <di:waypoint x="455" y="240"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_03_ConsultarDados_di" bpmnElement="Flow_03_ConsultarDados">
        <di:waypoint x="480" y="215"/>
        <di:waypoint x="480" y="120"/>
        <di:waypoint x="600" y="120"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_04_Agendamento_di" bpmnElement="Flow_04_Agendamento">
        <di:waypoint x="505" y="240"/>
        <di:waypoint x="600" y="240"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_05_2Via_di" bpmnElement="Flow_05_2Via">
        <di:waypoint x="480" y="265"/>
        <di:waypoint x="480" y="350"/>
        <di:waypoint x="600" y="350"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_06_Duvidas_di" bpmnElement="Flow_06_Duvidas">
        <di:waypoint x="480" y="265"/>
        <di:waypoint x="480" y="460"/>
        <di:waypoint x="600" y="460"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_07_di" bpmnElement="Flow_07">
        <di:waypoint x="700" y="120"/>
        <di:waypoint x="830" y="120"/>
        <di:waypoint x="830" y="215"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_08_di" bpmnElement="Flow_08">
        <di:waypoint x="730" y="240"/>
        <di:waypoint x="805" y="240"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_09_di" bpmnElement="Flow_09">
        <di:waypoint x="700" y="350"/>
        <di:waypoint x="830" y="350"/>
        <di:waypoint x="830" y="265"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_10_di" bpmnElement="Flow_10">
        <di:waypoint x="700" y="460"/>
        <di:waypoint x="830" y="460"/>
        <di:waypoint x="830" y="265"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_11_Sim_di" bpmnElement="Flow_11_Sim">
        <di:waypoint x="855" y="240"/>
        <di:waypoint x="942" y="240"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_12_Nao_di" bpmnElement="Flow_12_Nao">
        <di:waypoint x="830" y="265"/>
        <di:waypoint x="830" y="320"/>
        <di:waypoint x="942" y="320"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_13_di" bpmnElement="Flow_13">
        <di:waypoint x="978" y="320"/>
        <di:waypoint x="1042" y="320"/>
      </bpmndi:BPMNEdge>

    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>

</bpmn:definitions>
